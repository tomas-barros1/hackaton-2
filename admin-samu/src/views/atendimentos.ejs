<!DOCTYPE html>
<html>
<head>
    <title>Painel de Atendimentos SAMU</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .dashboard {
            padding: 20px;
        }

        .card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card-header {
            background-color: #dc3545;
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .status-pendente { 
            color: #ff9800;
            font-weight: bold;
        }
        .status-atendimento { 
            color: #2196F3;
            font-weight: bold;
        }
        .status-finalizado { 
            color: #4CAF50;
            font-weight: bold;
        }

        #map {
            height: 400px;
            border-radius: 15px;
        }

        .stats-card {
            text-align: center;
            padding: 20px;
        }

        .stats-number {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .refresh-button {
            position: absolute;
            right: 20px;
            top: 20px;
        }

        .location-button {
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .location-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="container-fluid">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h4 class="mb-0"><i class="fas fa-ambulance me-2"></i>Painel de Atendimentos SAMU</h4>
                            <button onclick="carregarAtendimentos()" class="btn btn-light btn-sm">
                                <i class="fas fa-sync-alt"></i> Atualizar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card stats-card">
                        <i class="fas fa-clock fa-2x text-warning"></i>
                        <div class="stats-number" id="pendentes">0</div>
                        <div>Pendentes</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stats-card">
                        <i class="fas fa-spinner fa-2x text-primary"></i>
                        <div class="stats-number" id="em-atendimento">0</div>
                        <div>Em Atendimento</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stats-card">
                        <i class="fas fa-check-circle fa-2x text-success"></i>
                        <div class="stats-number" id="finalizados">0</div>
                        <div>Finalizados</div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Lista de Atendimentos</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Protocolo</th>
                                            <th>Nome</th>
                                            <th>WhatsApp</th>
                                            <th>Natureza</th>
                                            <th>Status</th>
                                            <th>Localização</th>
                                        </tr>
                                    </thead>
                                    <tbody id="atendimentosBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Mapa do Atendimento</h5>
                        </div>
                        <div class="card-body">
                            <div id="map" style="height: 400px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let currentMarker;

        function initMap() {
            map = L.map('map').setView([-14.235004, -51.92528], 4);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        }

        function abrirGoogleMaps(lat, lng) {
            window.open(`https://www.google.com/maps?q=${lat},${lng}`, '_blank');
        }

        function mostrarLocalizacao(lat, lng, info) {
            if (!lat || !lng) {
                console.error('Latitude ou longitude inválidos');
                return;
            }

            if (currentMarker) {
                map.removeLayer(currentMarker);
            }

            try {
                currentMarker = L.marker([parseFloat(lat), parseFloat(lng)])
                    .addTo(map)
                    .bindPopup(`
                        ${info}<br>
                        <button class="btn btn-sm btn-primary mt-2" onclick="abrirGoogleMaps(${lat}, ${lng})">
                            <i class="fas fa-external-link-alt"></i> Abrir no Google Maps
                        </button>
                    `)
                    .openPopup();

                currentMarker.on('click', function() {
                    abrirGoogleMaps(lat, lng);
                });

                map.setView([parseFloat(lat), parseFloat(lng)], 15);
            } catch (error) {
                console.error('Erro ao mostrar localização:', error);
            }
        }

        function atualizarEstatisticas(atendimentos) {
            const pendentes = atendimentos.filter(a => a.status === 'Pendente').length;
            const emAtendimento = atendimentos.filter(a => a.status === 'Em Atendimento').length;
            const finalizados = atendimentos.filter(a => a.status === 'Finalizado').length;

            document.getElementById('pendentes').textContent = pendentes;
            document.getElementById('em-atendimento').textContent = emAtendimento;
            document.getElementById('finalizados').textContent = finalizados;
        }

        async function carregarAtendimentos() {
            try {
                const response = await fetch('/api/atendimentos');
                const atendimentos = await response.json();
                
                const tbody = document.getElementById('atendimentosBody');
                tbody.innerHTML = '';

                atualizarEstatisticas(atendimentos);

                atendimentos.forEach(atendimento => {
                    const row = document.createElement('tr');
                    
                    const temLocalizacao = atendimento.localizacao && 
                                         atendimento.localizacao.latitude && 
                                         atendimento.localizacao.longitude;
                    
                    row.innerHTML = `
                        <td>${atendimento.protocolo || '-'}</td>
                        <td>${atendimento.nomeUsuario || '-'}</td>
                        <td>${atendimento.numeroWhatsapp || '-'}</td>
                        <td>${atendimento.naturezaEmergencia || '-'}</td>
                        <td class="status-${(atendimento.status || '').toLowerCase()}">${atendimento.status || '-'}</td>
                        <td>
                            ${temLocalizacao ? `
                                <div class="btn-group">
                                    <button class="btn btn-primary btn-sm" onclick="mostrarLocalizacao(
                                        '${atendimento.localizacao.latitude}', 
                                        '${atendimento.localizacao.longitude}',
                                        '<b>Paciente:</b> ${atendimento.nomeUsuario}<br><b>Status:</b> ${atendimento.status}'
                                    )">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="abrirGoogleMaps(
                                        ${atendimento.localizacao.latitude}, 
                                        ${atendimento.localizacao.longitude}
                                    )">
                                        <i class="fas fa-external-link-alt"></i>
                                    </button>
                                </div>
                            ` : '<span class="badge bg-secondary">Sem localização</span>'}
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                const primeiroComLocalizacao = atendimentos.find(a => 
                    a.localizacao && a.localizacao.latitude && a.localizacao.longitude
                );
                
                if (primeiroComLocalizacao) {
                    mostrarLocalizacao(
                        primeiroComLocalizacao.localizacao.latitude,
                        primeiroComLocalizacao.localizacao.longitude,
                        `<b>Paciente:</b> ${primeiroComLocalizacao.nomeUsuario}<br><b>Status:</b> ${primeiroComLocalizacao.status}`
                    );
                }

            } catch (error) {
                console.error('Erro ao carregar atendimentos:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            carregarAtendimentos();
        });

        setInterval(carregarAtendimentos, 30000);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 